# Multi-Cohort Aggregation - Deep Analysis & Fix Plan

**Date**: December 14, 2025
**Status**: CRITICAL - Bugs found in aggregation logic
**Priority**: MUST FIX before Sunday

---

## Current Situation

As of Dec 14, we have:
- **Cohort 1**: Started Dec 7, all 7 models with active positions
- **Cohort 2**: Started Dec 14, all 7 models with $10k cash, no positions yet
- **ALL 7 models exist in BOTH cohorts**

Example (Claude Opus 4.5):
- Cohort 1: Cash $1,950 + Positions $8,428.39 = **$10,378.39** (+$378.39 P/L, +3.78%)
- Cohort 2: Cash $10,000 + Positions $0 = **$10,000.00** ($0 P/L, 0%)

---

## Critical Bugs Identified

### BUG #1: Performance Chart Averaging ⚠️ CRITICAL

**File**: `/opt/forecasterarena/app/api/performance-data/route.ts:76-82`

**Current Code**:
```typescript
if (dateData[row.model_id] === undefined) {
  dateData[row.model_id] = row.total_value;
} else {
  // Average if multiple cohorts
  dateData[row.model_id] = ((dateData[row.model_id] as number) + row.total_value) / 2;
}
```

**Problem**: Averages portfolio values across cohorts.

**Example**:
- Claude Cohort 1 snapshot: $10,378.39
- Claude Cohort 2 snapshot: $10,000.00
- Chart shows: ($10,378.39 + $10,000) / 2 = **$10,189.20** ❌

**Why This Is Wrong**:
No actual Claude Opus instance has $10,189.20. This number is meaningless. It doesn't represent:
- The total capital deployed ($20,378.39)
- The total P/L (+$378.39)
- Any actual agent's portfolio value

**Correct Approach**:
Track **aggregate P/L** from all instances of that model type.

**Fixed Logic**:
```typescript
// For aggregate view (no cohort filter), show cumulative P/L
// Baseline is num_cohorts × $10,000
if (!cohortId) {
  // Sum P/L values, not portfolio values
  const pnlValue = row.total_value - INITIAL_BALANCE;
  dateData[row.model_id] = ((dateData[row.model_id] as number) || 0) + pnlValue;
} else {
  // For single cohort, show actual portfolio value
  dateData[row.model_id] = row.total_value;
}
```

**Result After Fix**:
- Chart shows: +$378.39 (cumulative P/L from both cohorts)
- Starting baseline: $0
- As cohorts succeed/fail, line goes up/down
- Meaningful comparison across models

---

### BUG #2: Portfolio Value Fallback ⚠️ CRITICAL

**Files Affected**:
1. `/opt/forecasterarena/app/api/cohorts/[id]/models/[modelId]/route.ts:84`
2. `/opt/forecasterarena/app/api/models/[id]/route.ts:72`
3. `/opt/forecasterarena/app/api/cohorts/[id]/route.ts:71`

**Current Code**:
```typescript
const totalValue = latestSnapshot?.total_value || agent.cash_balance + agent.total_invested;
```

**Problem**: `total_invested` is **cost basis**, not current value!

**Example (Claude Opus Cohort 1)**:
- Cash: $1,950
- total_invested: $8,050 (what was paid for positions)
- Actual position value: $8,428.39 (current market value)
- Fallback shows: $1,950 + $8,050 = **$10,000** ❌
- Should show: $1,950 + $8,428.39 = **$10,378.39** ✓

**Fixed Logic**:
```typescript
// Calculate actual position values
const db = getDb();
const positionValueResult = db.prepare(`
  SELECT COALESCE(SUM(current_value), 0) as total_position_value
  FROM positions
  WHERE agent_id = ? AND status = 'open'
`).get(agent.id) as { total_position_value: number };

const totalValue = latestSnapshot?.total_value ||
  (agent.cash_balance + positionValueResult.total_position_value);
```

**Impact**: Without this fix, any agent without a recent snapshot will show $10,000 portfolio value even if they have gains/losses.

---

### BUG #3: Model Detail Return % Calculation ⚠️ MEDIUM

**File**: `/opt/forecasterarena/app/api/models/[id]/route.ts:92-94`

**Current Code**:
```typescript
const avgPnlPercent = cohortPerformance.length > 0
  ? cohortPerformance.reduce((sum, c) => sum + c.total_pnl_percent, 0) / cohortPerformance.length
  : 0;
```

**Problem**: Simple average of percentages, not weighted by capital.

**Example**:
- Cohort 1: +50% on $10k = +$5k
- Cohort 2: -20% on $10k = -$2k
- Current: (50% + -20%) / 2 = **15%**
- Actual: (+$5k - $2k) / $20k = **15%**

**Status**: This actually works correctly IF all cohorts have same starting capital ($10k). But if we ever have:
- Bankruptcy scenarios (one cohort has $0 remaining)
- Different starting capitals
- Partial cohorts

Then simple averaging will be wrong.

**Better Approach**:
```typescript
const totalPnl = cohortPerformance.reduce((sum, c) => sum + c.total_pnl, 0);
const totalCapital = cohortPerformance.length * INITIAL_BALANCE;
const avgPnlPercent = totalCapital > 0 ? (totalPnl / totalCapital) * 100 : 0;
```

---

## Design Decisions

### Question 1: How should performance charts work?

**For Aggregate View (no cohort filter)**:
- **Y-axis**: Cumulative P/L from all instances ($)
- **Baseline**: $0 (not $10,000 × num_cohorts)
- **Interpretation**: Total profit/loss generated by this model type across all cohorts

**For Cohort-Specific View**:
- **Y-axis**: Actual portfolio value ($)
- **Baseline**: $10,000 (starting capital)
- **Interpretation**: Portfolio value for this specific agent in this cohort

### Question 2: How should bankruptcy be handled?

**Current Status**: No special handling exists.

**Agent is "bankrupt" when**:
- cash_balance ≈ $0 (< $50)
- All positions closed or worthless
- Cannot make new trades (insufficient capital)

**Recommended Approach**:
1. **Include in aggregates** - bankruptcy is a real outcome
2. **Add status field** to agents table: 'active' | 'bankrupt' | 'liquidated'
3. **Mark clearly in UI** but don't exclude from P/L calculations
4. **Example**: If Claude goes bankrupt in Cohort 1 (-$10k) but succeeds in Cohort 2 (+$2k), aggregate shows -$8k total

### Question 3: What about models in different cohorts?

**Scenario**: New model added in Cohort 3, wasn't in Cohorts 1-2.

**Recommended Approach**:
- Chart should show `null` or `undefined` for periods before model existed
- Don't backfill with $0 (misleading)
- Frontend chart library should handle missing data gracefully
- Leaderboard should still show aggregate stats (only from cohorts where model participated)

---

## Verification Scenarios

### Scenario 1: Same model, multiple cohorts (Current)
- Model: Claude Opus 4.5
- Cohort 1: +$378.39 (+3.78%)
- Cohort 2: $0 (0%)
- **Aggregate Chart**: Should show +$378.39 cumulative P/L
- **Aggregate Leaderboard**: +$378.39 / $20,000 = +1.89% return
- **Model Detail Page**: Total P/L: +$378.39, Avg Return: +1.89%

### Scenario 2: Bankruptcy scenario
- Model: Example X
- Cohort 1: -$10,000 (-100%, bankrupt)
- Cohort 2: +$2,000 (+20%)
- **Aggregate Chart**: Should show -$8,000 cumulative P/L
- **Aggregate Leaderboard**: -$8,000 / $20,000 = -40% return
- **Status**: Cohort 1 marked 'bankrupt', Cohort 2 'active'

### Scenario 3: New model mid-run
- Model: New LLM Z (added in Cohort 3)
- Cohorts 1-2: Not present
- Cohort 3: +$500 (+5%)
- **Aggregate Chart**: No data for weeks 1-2, then shows +$500 from week 3
- **Aggregate Leaderboard**: +$500 / $10,000 = +5% return (only 1 cohort)

---

## Implementation Priority

### MUST FIX (Before Sunday):
1. ✅ Fix performance chart averaging logic (use P/L sum, not value average)
2. ✅ Fix portfolio value fallback (calculate actual position values)
3. ✅ Fix model detail return % (use weighted average)

### SHOULD FIX (This week):
4. Add bankruptcy status tracking
5. Handle missing data in charts (models not in all cohorts)
6. Add data validation tests

### CAN DEFER:
7. Add bankruptcy UI indicators
8. Advanced analytics (Sharpe ratio, drawdown, etc.)
9. Per-category performance breakdown

---

## Testing Checklist

After fixes are applied:

- [ ] Test aggregate chart with current data (2 cohorts, same 7 models)
- [ ] Verify Claude Opus shows +$378.39 P/L, not $10,189.20
- [ ] Test portfolio value calculation without snapshot
- [ ] Verify it uses actual position values, not cost basis
- [ ] Test model detail page aggregate stats
- [ ] Verify weighted return %, not simple average
- [ ] Test cohort-specific views still work correctly
- [ ] Simulate bankruptcy scenario (cash = $0, all positions closed)
- [ ] Test new model added mid-run (only in some cohorts)
- [ ] Verify leaderboard aggregation still correct

---

## Files to Modify

1. `/opt/forecasterarena/app/api/performance-data/route.ts`
   - Lines 76-82: Change averaging logic to P/L summation

2. `/opt/forecasterarena/app/api/cohorts/[id]/models/[modelId]/route.ts`
   - Line 84: Fix portfolio value fallback

3. `/opt/forecasterarena/app/api/models/[id]/route.ts`
   - Line 72: Fix portfolio value fallback
   - Lines 92-94: Fix return % calculation

4. `/opt/forecasterarena/app/api/cohorts/[id]/route.ts`
   - Line 71: Fix portfolio value fallback

---

## Current Leaderboard Verification

The aggregate leaderboard query (`getAggregateLeaderboard`) appears CORRECT:

```sql
SUM(COALESCE(ls.total_pnl, 0)) as total_pnl,  -- ✓ Sums P/L across cohorts
(total_pnl / (num_cohorts * ?)) * 100 as total_pnl_percent  -- ✓ Weighted by total capital
```

No changes needed here!

---

**Next Steps**: Proceed with implementing the 3 critical fixes.
